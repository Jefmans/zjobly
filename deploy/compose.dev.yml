version: "3.9"

services:
  traefik:
    image: traefik:v3
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.le.acme.email=ops@zjobly.com
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
    ports: ["80:80", "443:443"]
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "../letsencrypt:/letsencrypt"
    restart: unless-stopped

  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    volumes: [pgdata:/var/lib/postgresql/data]
    restart: unless-stopped

  redis:
    image: redis:7
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes: [minio:/data]
    ports: ["9001:9001"]   # dev console
    restart: unless-stopped

  opensearch:
    image: opensearchproject/opensearch:2
    environment:
      discovery.type: single-node
      OPENSEARCH_SECURITY_ENABLED: "false"
      DISABLE_INSTALL_DEMO_CONFIG: "true"
    ulimits:
      memlock: { soft: -1, hard: -1 }
    restart: unless-stopped

  frontend:
    build:
      context: ../services/web-frontend
    volumes:
      - ../services/web-frontend:/app
      - frontend_node_modules:/app/node_modules
    command: npm run dev -- --host --port 5173
    labels:
      - traefik.enable=true
      - traefik.http.routers.frontend.rule=Host(`zjobly.com`,`www.zjobly.com`)
      - traefik.http.routers.frontend.entrypoints=web,websecure
      - traefik.http.routers.frontend.tls=true
      - traefik.http.routers.frontend.tls.certresolver=le
      - traefik.http.middlewares.frontend-redirect.redirectregex.regex=^https?://www\\.zjobly\\.com/(.*)
      - traefik.http.middlewares.frontend-redirect.redirectregex.replacement=https://zjobly.com/$${1}
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.routers.frontend.middlewares=frontend-redirect,https-redirect
      - traefik.http.services.frontend.loadbalancer.server.port=5173
    restart: unless-stopped

  # --- Your SRS1: API ---
  media_api:
    build:
      context: ../services/video-ingest-service/backend
    env_file:
      - ../.env.dev
    depends_on: [postgres, redis, minio]
    labels:
      - traefik.enable=true
      - traefik.http.routers.media.rule=Host(`zjobly.com`) && PathPrefix(`/videos`)
      - traefik.http.routers.media.entrypoints=web,websecure
      - traefik.http.routers.media.tls=true
      - traefik.http.routers.media.tls.certresolver=le
      - traefik.http.routers.media.middlewares=https-redirect
      - traefik.http.services.media.loadbalancer.server.port=8000
    restart: unless-stopped

  # --- Your SRS1: Worker ---
  media_worker:
    build:
      context: ../services/video-ingest-service
      dockerfile: worker/Dockerfile
    env_file:
      - ../.env.dev
    depends_on: [postgres, redis, minio]
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2g
    restart: unless-stopped

volumes:
  pgdata:
  minio:
  frontend_node_modules:
