services:
  portainer_agent:
    image: portainer/agent:latest
    container_name: portainer_agent
    restart: always
    ports:
      - "9001:9001"  # Insecure if exposed to all IPs!
    networks:
      - internal_backend
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes

  traefik:
    image: traefik:v3
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.le.acme.email=ops@zjobly.com
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
    ports: ["80:80", "443:443"]
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
    restart: unless-stopped

  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    volumes: [pgdata:/var/lib/postgresql/data]
    restart: unless-stopped

  redis:
    image: redis:7
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes: [minio:/data]
    ports: ["9001:9001"]   # dev console
    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.2
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: -Xms512m -Xmx512m
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65536, hard: 65536 }
    volumes: [esdata:/usr/share/elasticsearch/data]
    ports: ["9200:9200"]
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.2
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    depends_on: [elasticsearch]
    ports: ["5601:5601"]   # dev console
    restart: unless-stopped

  frontend:
    build:
      context: ./services/web-frontend
    volumes:
      - ./services/web-frontend:/app
      - frontend_node_modules:/app/node_modules
    command: npm run dev -- --host --port 5173
    labels:
      - traefik.enable=true
      - traefik.http.routers.frontend.rule=Host(`zjobly.com`)
      - traefik.http.routers.frontend.entrypoints=web,websecure
      - traefik.http.routers.frontend.tls=true
      - traefik.http.routers.frontend.tls.certresolver=le
      - traefik.http.routers.frontend.tls.domains[0].main=zjobly.com
      - traefik.http.routers.frontend.tls.domains[0].sans[0]=www.zjobly.com
      - traefik.http.routers.frontend.middlewares=frontend-https-redirect
      - traefik.http.middlewares.frontend-https-redirect.redirectscheme.scheme=https

      - traefik.http.routers.frontend-www.rule=Host(`www.zjobly.com`)
      - traefik.http.routers.frontend-www.entrypoints=web,websecure
      - traefik.http.routers.frontend-www.tls=true
      - traefik.http.routers.frontend-www.tls.certresolver=le
      - traefik.http.routers.frontend-www.middlewares=frontend-www-to-apex,frontend-https-redirect
      - traefik.http.middlewares.frontend-www-to-apex.redirectregex.regex=^https?://www\\.zjobly\\.com/(.*)
      - traefik.http.middlewares.frontend-www-to-apex.redirectregex.replacement=https://zjobly.com/$${1}
      - traefik.http.services.frontend.loadbalancer.server.port=5173
    restart: unless-stopped

  # --- Your SRS1: API ---
  media_api:
    build:
      context: ./services/video-ingest-service/backend
    env_file:
      - ./.env.dev
    depends_on: [postgres, redis, minio]
    labels:
      - traefik.enable=true
      - traefik.http.routers.media.rule=Host(`zjobly.com`) && PathPrefix(`/videos`)
      - traefik.http.routers.media.entrypoints=web,websecure
      - traefik.http.routers.media.tls=true
      - traefik.http.routers.media.tls.certresolver=le
      - traefik.http.routers.media.middlewares=frontend-https-redirect
      - traefik.http.services.media.loadbalancer.server.port=8000
    restart: unless-stopped

  # --- Your SRS1: Worker ---
  media_worker:
    build:
      context: ./services/video-ingest-service
      dockerfile: worker/Dockerfile
    env_file:
      - ./.env.dev
    depends_on: [postgres, redis, minio]
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2g
    labels:
      - traefik.enable=false
    restart: unless-stopped

  # --- AI: Transcription via OpenAI Whisper API ---
  transcription_worker:
    build:
      context: ./services/transcription
    env_file:
      - ./.env.dev
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      REDIS_URL: redis://redis:6379/0
      PGHOST: postgres
      PGUSER: app
      PGPASSWORD: app
      PGDATABASE: app
    depends_on: [redis, minio, postgres]
    restart: unless-stopped

  # --- AI: Embeddings, keywords, titles ---
  nlp_worker:
    build:
      context: ./services/nlp
    env_file:
      - ./.env.dev
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ELASTIC_URL: http://elasticsearch:9200
      REDIS_URL: redis://redis:6379/0
      PGHOST: postgres
      PGUSER: app
      PGPASSWORD: app
      PGDATABASE: app
    depends_on: [redis, postgres, elasticsearch]
    restart: unless-stopped

volumes:
  pgdata:
  minio:
  frontend_node_modules:
  esdata:
